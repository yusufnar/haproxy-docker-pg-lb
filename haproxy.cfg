global
    maxconn 100
    # Log to stdout (Docker-friendly)
    log stdout format raw local0
    # Runtime API socket for dynamic server management
    stats socket /tmp/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    mode tcp
    log global
    # Log health check status changes (UP/DOWN)
    option log-health-checks
    timeout connect 2s
    timeout client 1m
    timeout server 1m

frontend pg_replica_frontend
    bind *:5432
    default_backend pg_replica_backend

backend pg_replica_backend
    mode tcp
    balance roundrobin
    # Retry logic for seamless failover during detection window
    option redispatch
    retries 1
    
    # Option httpchk is used to check the health via the centralized healthcheck service
    option httpchk
    http-check connect port 8008 addr healthcheck
    # uri-lf allows using log-format strings (like %[srv_name]) in the URI
    http-check send meth GET uri-lf /%[srv_name]
    http-check expect string OK
    
    server replica1 replica1:5432 check addr healthcheck port 8008 inter 1s fall 2 rise 2 weight 10
    server replica2 replica2:5432 check addr healthcheck port 8008 inter 1s fall 2 rise 2 weight 10
    
    # Fallback to primary when ALL replicas are down (backup keyword)
    # health_check.py detects primary via pg_is_in_recovery() and does simple SELECT 1 check
    server primary primary:5432 check addr healthcheck port 8008 inter 1s fall 2 rise 2 backup
